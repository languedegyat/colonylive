#!/usr/bin/python

import os
import time
import sys
import getpass
import numpy as np
import subprocess as sp

from clive.core.conf import Configure

cfg = Configure()


def main():
    #set_config()
    #set_database()
    #set_package()
    #set_vuescan()
    set_layout()


# config file
#==================================================

try:
    cfg.load()
    step = int(cfg[('setup','step')])
except:
    cfg.set_default()
    cfg.update()


def set_value(msg, key):
    try: 
        default = cfg[key]
    except:
        default = ''

    while True:
        ans = raw_input("%s [%s]: " % (msg, default))
        if ans == "":
            if default != '':
                value = default
                break
        else:
            value = ans
            break
    cfg[key] = value
    cfg.update()


def set_config():
    os.system('clear')
    print "Configure setting"
    print "========================="
    print "Item [Current value]: "
    print 
    print "Adiminstrator"
    set_value('- Name', ('admin','name'))
    set_value('- email', ('admin','email'))

    print "\nConnected scanner IDs -- e.g.) 1,2,3"
    set_value('- IDs', ('scan','scanner_ids'))

    print "\nMySQL database"
    set_value('- Host', ('db','host'))
    set_value('- Database', ('db','db'))
    set_value('- Port', ('db','port'))
    set_value('- User', ('db','user'))
    set_value('- Password', ('db','pass'))
    print "[OK]"
    raw_input("Press Enter...")



# Database setting
#==================================================

from clive.db.database import DB
from clive.db.schema import make_all_tables
from clive.db.handler import ScannerHandler
scanner_handler = ScannerHandler()

def set_database():
    os.system('clear')
    print "Database Setting"
    print "========================="
    print 
    db = DB()
    try:
        db.session.execute("show tables")
    except:
        print "Cannot connect to MySQL database"
        print "Check MySQL account information"
        quit()
    make_all_tables()
    
    sids = map(int, cfg[('scan','scanner_ids')].split(","))
    for sid in sids:
        try:
            scanner_handler.load(sid)
        except:
            scanner_handler.create(sid)
    print "[OK]"
    raw_input("Press Enter...")


# Install packages
#==================================================

def set_package():
    os.system('clear')
    print "Install packages"
    print "========================="
    print 
    sp.call('sudo apt-get -qq update',shell=True)
    items = [
        'r-base',
        'openssh-server',
        'ntpdate',
        'xautomation',
        'wmctrl',
        'python-mysqldb',
        'python-numpy',
        'python-scipy',
        'python-opencv',
        'python-matplotlib',
        'python-rpy2',
        'python-webpy'
        ]
    cmd = 'sudo apt-get -qq -y install ' + " ".join(items)
    sp.call(cmd,shell=True)
    print "[OK]"
    raw_input("Press Enter...")



# VueScan setting
#==================================================

from clive.setup.auto_vuescan import gui_setup

def set_vuescan():
    os.system('clear')
    print "VueScan Setting"
    print "========================="
    print 
    
    if cfg[('vuescan','pos_input_tab')] != "":
        while True:
            ans = raw_input("Re-setup? yes or no:")
            if ans in ["yes", 'y']:
                break
            if ans in ["no", 'n']:
                return

    gui_setup()



# Clip layout
#==================================================

from clive.setup.clip_layout import layout_setup
from clive.scan.gui_scan import gui_scan
from clive.scan.prep import prep_gui

def set_layout():
    os.system('clear')
    print "Scan layout Setting"
    print "========================="
    print
    
    print "Which scanner you will use for setup?"
    sids = cfg[('scan','scanner_ids')]
    print "Available scanner IDs: %s" % sids
    while True:
        ans = raw_input("scanner ID:")
        if ans in sids:
            sid = int(ans)
            break
    
    print "Set all test plates on the scanner ID %d, then type 'yes' & enter" % sid
    while True:
        ans = raw_input()
        if ans in ["yes"]:
            break
    
    prep_gui()

    gui_scan(sid, "layout_set.tif")
    
    print "starting Inkscape..."
    print "Draw red box on the test plates, then save as png file"
    print "Press enter"
    raw_input()
    
    print 
    layout_setup()



if __name__ == "__main__":
    main()

